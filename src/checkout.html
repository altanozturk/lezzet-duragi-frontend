<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ödeme - Lezzet Durağı</title>
    <link href="output.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="./scripts/navbar.js"></script>
</head>

<body class="bg-slate-900 text-gray-100">
    <div id="navbar-placeholder"></div>

    <div class="py-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Sol Taraf - Teslimat Bilgileri -->
                <div class="bg-slate-800 rounded-lg shadow-xl p-6">
                    <h2 class="text-2xl font-semibold mb-2">Teslimat Bilgileri</h2>
                    <div id="message" class="hidden mb-6 p-4 rounded-lg text-center font-semibold"></div>
                    <form id="delivery-form" class="space-y-4" novalidate>
                        <div>
                            <label class="block text-gray-300 mb-2">Ad Soyad</label>
                            <input type="text" id="fullName" required
                                class="w-full px-4 py-3 rounded-lg bg-slate-700 border border-slate-600 text-white focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200 outline-none transition"
                                oninvalid="this.setCustomValidity('Lütfen ad soyad bilgisini girin')"
                                oninput="this.setCustomValidity('')">
                        </div>
                        <div>
                            <label class="block text-gray-300 mb-2">Telefon</label>
                            <input type="tel" id="phone" required
                                class="w-full px-4 py-3 rounded-lg bg-slate-700 border border-slate-600 text-white focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200 outline-none transition"
                                oninvalid="this.setCustomValidity('Lütfen telefon numaranızı girin')"
                                oninput="this.setCustomValidity('')">
                        </div>
                        <div>
                            <label class="block text-gray-300 mb-2">Adres</label>
                            <textarea id="address" rows="3" required
                                class="w-full px-4 py-3 rounded-lg bg-slate-700 border border-slate-600 text-white focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200 outline-none transition"
                                oninvalid="this.setCustomValidity('Lütfen teslimat adresini girin')"
                                oninput="this.setCustomValidity('')"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-300 mb-2">Not (İsteğe bağlı)</label>
                            <textarea id="note" rows="2"
                                class="w-full px-4 py-3 rounded-lg bg-slate-700 border border-slate-600 text-white focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200 outline-none transition"></textarea>
                        </div>
                    </form>
                </div>

                <!-- Sağ Taraf - Sipariş Özeti ve Ödeme -->
                <div class="space-y-6">
                    <!-- Sipariş Özeti -->
                    <div class="bg-slate-800 rounded-lg shadow-xl p-6">
                        <h2 class="text-2xl font-semibold mb-6">Sipariş Özeti</h2>
                        <div id="orderItems" class="space-y-4 mb-6">
                            <!-- Sipariş öğeleri buraya gelecek -->
                        </div>
                        <div class="border-t border-slate-700 pt-4">
                            <div class="flex justify-between mb-2">
                                <span class="text-gray-300">Ara Toplam</span>
                                <span id="orderTotal" class="text-gray-300"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Ödeme Butonu -->
                    <button onclick="placeOrder()"
                        class="w-full bg-yellow-500 text-white py-4 px-6 rounded-lg hover:bg-yellow-600 transition duration-200 shadow-lg shadow-yellow-500/20 font-semibold text-lg">
                        Siparişi Tamamla
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="footer-placeholder"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            updateNavbar();
        });
        $('#footer-placeholder').load('footer.html');

        function loadCartSummary() {
            const token = localStorage.getItem('token');
            if (!token) return;

            axios.get('http://localhost:8080/api/cart/summary', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => {
                const { items, total } = response.data;
                
                // Ürünleri listele
                const itemsContainer = document.getElementById('orderItems');
                itemsContainer.innerHTML = items.map(item => `
                    <div class="flex items-center justify-between py-2">
                        <div class="flex items-center">
                            <img src="http://localhost:8080${item.product.imageUrl}" 
                                alt="${item.product.name}" 
                                class="w-12 h-12 object-cover rounded-lg mr-3">
                            <div>
                                <span class="font-medium">${item.product.name}</span>
                                <span class="text-gray-400 text-sm ml-2">x ${item.quantity}</span>
                            </div>
                        </div>
                        <span class="font-medium">${(item.quantity * item.priceAtAddition).toFixed(2)} TL</span>
                    </div>
                `).join('');

                // Toplam tutarı güncelle
                document.getElementById('orderTotal').textContent = total.toFixed(2) + ' TL';
            })
            .catch(error => {
                console.error('Error loading cart summary:', error);
            });
        }

        // Sayfa yüklendiğinde özeti yükle
        document.addEventListener('DOMContentLoaded', loadCartSummary);

        function showMessage(text, type = 'error') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `mb-4 p-4 rounded-lg text-center font-semibold ${
                type === 'error' 
                    ? 'bg-red-500/10 text-red-500 border border-red-500/20' 
                    : 'bg-green-500/10 text-green-500 border border-green-500/20'
            }`;
            messageDiv.classList.remove('hidden');

            // 3 saniye sonra mesajı gizle
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 3000);
        }

        function placeOrder() {
            const token = localStorage.getItem('token');
            if (!token) return;

            const form = document.getElementById('delivery-form');
            
            // Form validasyonunu kontrol et
            if (!form.checkValidity()) {
                // Form geçerli değilse, tarayıcının kendi hata mesajlarını göster
                form.reportValidity();
                return;
            }

            const orderData = {
                fullName: document.getElementById('fullName').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                note: document.getElementById('note').value
            };

            axios.post('http://localhost:8080/api/orders/create', orderData, {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => {
                sessionStorage.setItem('orderCompleted', 'true');
                window.location.href = '/src/order-success.html';
            })
            .catch(error => {
                console.error('Error placing order:', error);
                showMessage('Sipariş oluşturulurken bir hata oluştu');
            });
        }
    </script>
</body>

</html>